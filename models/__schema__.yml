version: 2

sources:
  - name: ga4
    database: "{{ var('project') }}" 
    schema: "{{ var('dataset') }}" 
    tables:
      - name: events
        identifier: events_* # Scans across all sharded event tables. Use the 'start_date' variable in `dbt_project.yml` file to limit this scan.
        description: Main events table composed of the exported GA4 day sharded event tables (event_YYYMMDD).
      
      - name: events_intraday
        identifier: events_intraday_*
        description: Intraday events table which is optionally exported by GA4. Always contains events from the current day.

models:  
  - name: base_ga4__events
    description: Base events model that pulls all fields from raw data. Resulting table is partitioned on event_date and is useful in that BQ queries can be cached against this table, but not against wildcard searches from the original tables which are sharded on date. Some light transformation and renaming beyond the base events model. Adds surrogate keys for sessions and events.
  
  - name: base_ga4__events_intraday
    description: Base model for intraday events that will be unioned to the past events stored in the incremental model. 
  
  - name: stg_ga4__event_to_query_string_params
    description: This model pivots the query string parameters contained within the event's page_location field to become rows. Each row is a single parameter/value combination contained in a single event's query string.
  
  - name: stg_ga4__event_page_view
    description: GA4 events filtered to only show 'page_view' events. Pivots common event parameters into separate columns. Identifies the first and last pageview in the 'is_entrance' and 'is_exit' columns. 
    columns: 
      - name: page_location
        tests:
          - not_null
  
  - name: stg_ga4__event_session_start
    description: GA4 events filtered to only show 'session_start' events. Pivots common event parameters into separate columns. 
  
  - name: stg_ga4__event_purchase
    description: GA4 events filtered to only show 'purchase' events. Pivots common event parameters into separate columns. 
  
  - name: stg_ga4__users_first_last_pageviews
    description: Captures data related to the first and last page view that each user has completed (by user_key).
    columns:
      - name: user_key
        tests:
          - unique
  
  - name: stg_ga4__users_first_last_events
    description: Captures the first and last event completed by the user in order to pull in the first and last geo, device, and traffic source seen from the user.
    columns:
      - name: user_key
        tests: 
          - unique
  
  - name: stg_ga4__events
    description: Staging model that contains window functions used to generate unique keys.
    columns:
      - name: event_key
        tests:
          - unique
  
  - name: stg_ga4__event_scroll
    description: Staging model containing only 'scroll' events. Includes the 'percent_scrolled' parameter.
  
  - name: stg_ga4__derived_user_properties
    description: Optional model that will pull out the most recent instance of a particular event parameter for each user_key. Later used in the dim_ga4__users dimension table.
    columns:
      - name: user_key
        tests:
          - unique  
  
  - name: stg_ga4__session_conversions
    description: Optional model that counts the number of events listed in the 'conversion_events' var. Aggregated by session_key.
  
  - name: stg_ga4__event_items
    description: Flattens out the 'items' field for e-commerce events such as purchase and add_to_cart.
  
  - name: stg_ga4__sessions_traffic_sources
    description: Finds the first session source, medium and campaign and adds the default channel grouping information. Aggregated by session_key.
    columns:
      - name: session_key
        tests:
          - unique
      
      - name: session_source
        description: Source value of the first event of the session after session_start and first_visit.
        tests:
          - not_null
      
      - name: session_medium
        description: Medium value of the first event of the session after session_start and first_visit.
        tests:
          - not_null
      
      - name: session_campaign
        description: Campaign value of the first event of the session after session_start and first_visit.
        tests:
          - not_null

  # USERS DIMENSION TABLE #
  - name: dim_ga4__users
    description: '{{ doc("dim_ga4__users") }}'
    columns:
      - name: user_key
        description: '{{ doc("user_key") }}'
        tests:
          - unique

      - name: first_seen_timestamp
        description: '{{ doc("first_seen_timestamp") }}'

      - name: first_seen_date
        description: '{{ doc("first_seen_date") }}'

      - name: last_seen_timestamp
        description: '{{ doc("last_seen_timestamp") }}'

      - name: last_seen_date
        description: '{{ doc("last_seen_date") }}'

      - name: sessions
        description: '{{ doc("sessions") }}'

      - name: page_views
        description: '{{ doc("page_views") }}'

      - name: purchases
        description: '{{ doc("purchases") }}'

      # FIRST_GEO #
      - name: continent
        description: '{{ doc("continent") }}'

      - name: sub_continent
        description: '{{ doc("sub_continent") }}'

      - name: country
        description: '{{ doc("country") }}'

      - name: region
        description: '{{ doc("region") }}'

      - name: city
        description: '{{ doc("city") }}'

      # FIRST_DEVICE #
      - name: category
        description: '{{ doc("category") }}'

      - name: mobile_brand_name
        description: '{{ doc("mobile_brand_name") }}'

      - name: mobile_model_name
        description: '{{ doc("mobile_model_name") }}'

      - name: mobile_marketing_name
        description: '{{ doc("mobile_marketing_name") }}'

      - name: mobile_os_hardware_model
        description: '{{ doc("mobile_os_hardware_model") }}'

      - name: operating_system
        description: '{{ doc("operating_system") }}'

      - name: operating_system_version
        description: '{{ doc("operating_system_version") }}'

      - name: vendor_id
        description: '{{ doc("vendor_id") }}'

      - name: advertising_id
        description: '{{ doc("advertising_id") }}'

      - name: language
        description: '{{ doc("language") }}'

      - name: is_limiting_ad_tracking
        description: '{{ doc("is_limiting_ad_tracking") }}'

      - name: time_zone_offset_seconds
        description: '{{ doc("time_zone_offset_seconds") }}'

      - name: browser
        description: '{{ doc("browser") }}'

      - name: browser_version
        description: '{{ doc("browser_version") }}'

      # FIRST_TRAFFIC_SOURCE #
      - name: medium
        description: '{{ doc("medium") }}'

      - name: name
        description: '{{ doc("name") }}'

      - name: source
        description: '{{ doc("source") }}'

      # LAST_GEO #
      - name: continent
        description: '{{ doc("continent") }}'

      - name: sub_continent
        description: '{{ doc("sub_continent") }}'

      - name: country
        description: '{{ doc("country") }}'

      - name: region
        description: '{{ doc("region") }}'

      - name: city
        description: '{{ doc("city") }}'

      # LAST_DEVICE #
      - name: category
        description: '{{ doc("category") }}'

      - name: mobile_brand_name
        description: '{{ doc("mobile_brand_name") }}'

      - name: mobile_model_name
        description: '{{ doc("mobile_model_name") }}'

      - name: mobile_marketing_name
        description: '{{ doc("mobile_marketing_name") }}'

      - name: mobile_os_hardware_model
        description: '{{ doc("mobile_os_hardware_model") }}'

      - name: operating_system
        description: '{{ doc("operating_system") }}'

      - name: operating_system_version
        description: '{{ doc("operating_system_version") }}'

      - name: vendor_id
        description: '{{ doc("vendor_id") }}'

      - name: advertising_id
        description: '{{ doc("advertising_id") }}'

      - name: language
        description: '{{ doc("language") }}'

      - name: is_limiting_ad_tracking
        description: '{{ doc("is_limiting_ad_tracking") }}'

      - name: time_zone_offset_seconds
        description: '{{ doc("time_zone_offset_seconds") }}'

      - name: browser
        description: '{{ doc("browser") }}'

      - name: browser_version
        description: '{{ doc("browser_version") }}'

      # LAST_TRAFFIC_SOURCE #
      - name: medium
        description: '{{ doc("medium") }}'

      - name: name
        description: '{{ doc("name") }}'

      - name: source
        description: '{{ doc("source") }}'

      #########################
      - name: first_page_location
        description: '{{ doc("first_page_location") }}'

      - name: first_page_hostname
        description: '{{ doc("first_page_hostname") }}'

      - name: first_page_referrer
        description: '{{ doc("first_page_referrer") }}'

      - name: last_page_location
        description: '{{ doc("last_page_location") }}'

      - name: last_page_hostname
        description: '{{ doc("last_page_hostname") }}'

      - name: last_page_referrer
        description: '{{ doc("last_page_referrer") }}'

  # SESSIONS DIMENSION TABLE #
  - name: dim_ga4__sessions
    description: '{{ doc("dim_ga4__sessions") }}'
    columns:
      - name: session_key
        description: '{{ doc("session_key") }}'
        tests:
          - unique

      - name: ga_session_number
        description: '{{ doc("ga_session_number") }}'

      - name: landing_page
        description: '{{ doc("landing_page") }}'

      - name: landing_page_hostname
        description: '{{ doc("landing_page_hostname") }}'

      # GEO #
      - name: continent
        description: '{{ doc("continent") }}'

      - name: sub_continent
        description: '{{ doc("sub_continent") }}'

      - name: country
        description: '{{ doc("country") }}'

      - name: region
        description: '{{ doc("region") }}'

      - name: city
        description: '{{ doc("city") }}'

      # DEVICE #
      - name: category
        description: '{{ doc("category") }}'

      - name: mobile_brand_name
        description: '{{ doc("mobile_brand_name") }}'

      - name: mobile_model_name
        description: '{{ doc("mobile_model_name") }}'

      - name: mobile_marketing_name
        description: '{{ doc("mobile_marketing_name") }}'

      - name: mobile_os_hardware_model
        description: '{{ doc("mobile_os_hardware_model") }}'

      - name: operating_system
        description: '{{ doc("operating_system") }}'

      - name: operating_system_version
        description: '{{ doc("operating_system_version") }}'

      - name: vendor_id
        description: '{{ doc("vendor_id") }}'

      - name: advertising_id
        description: '{{ doc("advertising_id") }}'

      - name: language
        description: '{{ doc("language") }}'

      - name: is_limiting_ad_tracking
        description: '{{ doc("is_limiting_ad_tracking") }}'

      - name: time_zone_offset_seconds
        description: '{{ doc("time_zone_offset_seconds") }}'

      - name: browser
        description: '{{ doc("browser") }}'

      - name: browser_version
        description: '{{ doc("browser_version") }}'

      # TRAFFIC_SOURCE #
      - name: medium
        description: '{{ doc("medium") }}'

      - name: name
        description: '{{ doc("name") }}'

      - name: source
        description: '{{ doc("source") }}'

      #########################
      - name: row_num
        description: '{{ doc("row_num") }}'

      - name: source
        description: '{{ doc("source") }}'

      - name: medium
        description: '{{ doc("medium") }}'

      - name: default_channel_grouping
        description: '{{ doc("default_channel_grouping") }}'

  # SESSIONS FACT TABLE #
  - name: fct_ga4__sessions
    description: '{{ doc("fct_ga4__sessions") }}'
    columns:
      - name: session_key
        description: '{{ doc("session_key") }}'
        tests:
          - unique

      - name: user_key
        description: '{{ doc("user_key") }}'

      - name: session_start_date
        description: '{{ doc("session_start_date") }}'

      - name: session_start_timestamp
        description: '{{ doc("session_start_timestamp") }}'

      - name: page_views
        description: '{{ doc("page_views") }}'

      - name: sum_event_value
        description: '{{ doc("sum_event_value") }}'

      - name: session_engaged
        description: '{{ doc("session_engaged") }}'

  # PAGES FACT TABLE #
  - name: fct_ga4__pages
    description: '{{ doc("fct_ga4__pages") }}'
    columns:
      - name: event_date
        description: '{{ doc("event_date") }}'

      - name: hour
        description: '{{ doc("hour") }}'

      - name: page_location
        description: '{{ doc("page_location") }}'

      - name: page_title
        description: '{{ doc("page_title") }}'

      - name: page_views
        description: '{{ doc("page_views") }}'

      - name: users
        description: '{{ doc("users") }}'

      - name: new_users
        description: '{{ doc("new_users") }}'

      - name: entrances
        description: '{{ doc("entrances") }}'

      - name: exits
        description: '{{ doc("exits") }}'

      - name: total_engagement_duration
        description: '{{ doc("total_engagement_duration") }}'

      - name: scroll_events
        description: '{{ doc("scroll_events") }}'

  # EVENTS TABLE #
  - name: ga4__events
    description: '{{ doc("ga4__events") }}'
    columns:
      - name: event_key
        description: '{{ doc("event_key") }}'
        tests:
          - unique

      - name: event_date
        description: '{{ doc("event_date") }}'

      - name: event_timestamp
        description: '{{ doc("event_timestamp") }}'

      - name: event_name
        description: '{{ doc("event_name") }}'

      - name: event_previous_timestamp
        description: '{{ doc("event_previous_timestamp") }}'

      - name: event_value
        description: '{{ doc("event_value") }}'

      - name: event_bundle_sequence_id
        description: '{{ doc("event_bundle_sequence_id") }}'

      - name: event_server_timestamp_offset
        description: '{{ doc("event_server_timestamp_offset") }}'


      - name: session_engaged
        description: '{{ doc("session_engaged") }}'

      - name: page_title
        description: '{{ doc("page_title") }}'

      - name: page_referrer
        description: '{{ doc("page_referrer") }}'

      - name: item_id
        description: '{{ doc("item_id") }}'

      - name: item_name
        description: '{{ doc("item_name") }}'

      - name: item_brand
        description: '{{ doc("item_brand") }}'

      - name: item_variant
        description: '{{ doc("item_variant") }}'

      - name: item_category
        description: '{{ doc("item_category") }}'

      - name: item_category2
        description: '{{ doc("item_category2") }}'

      - name: item_category3
        description: '{{ doc("item_category3") }}'

      - name: item_category4
        description: '{{ doc("item_category4") }}'

      - name: item_category5
        description: '{{ doc("item_category5") }}'

      - name: price_in_usd
        description: '{{ doc("price_in_usd") }}'

      - name: price
        description: '{{ doc("price") }}'

      - name: quantity
        description: '{{ doc("quantity") }}'

      - name: item_revenue_in_usd
        description: '{{ doc("item_revenue_in_usd") }}'

      - name: item_revenue
        description: '{{ doc("item_revenue") }}'

      - name: item_refund_in_usd
        description: '{{ doc("item_refund_in_usd") }}'

      - name: item_refund
        description: '{{ doc("item_refund") }}'

      - name: coupon
        description: '{{ doc("coupon") }}'

      - name: affiliation
        description: '{{ doc("affiliation") }}'

      - name: location_id
        description: '{{ doc("location_id") }}'

      - name: item_list_id
        description: '{{ doc("item_list_id") }}'

      - name: item_list_name
        description: '{{ doc("item_list_name") }}'

      - name: item_list_index
        description: '{{ doc("item_list_index") }}'

      - name: promotion_id
        description: '{{ doc("promotion_id") }}'

      - name: promotion_name
        description: '{{ doc("promotion_name") }}'

      - name: creative_name
        description: '{{ doc("creative_name") }}'

      - name: creative_slot
        description: '{{ doc("creative_slot") }}'